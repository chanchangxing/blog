<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  
  <title>ARouter | chanchangxing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="arouter原理arouter有三个阶段，编译器编译、arouter初始化、arouter跳转。
编译器编译arouter有三个最重要的注解@Route、@Interceptor和@Autowired，这三个注解在编译期通过arouter-compiler这个框架生成需要的代码。
总结一下这个阶段主要就是将我们打注解的地方生成想应的代码，主要分为拦截器、route和变量
先来看RouteProc">
<meta property="og:type" content="article">
<meta property="og:title" content="ARouter">
<meta property="og:url" content="https://chanchangxing.me/2019/12/02/ARouter解析/index.html">
<meta property="og:site_name" content="chanchangxing">
<meta property="og:description" content="arouter原理arouter有三个阶段，编译器编译、arouter初始化、arouter跳转。
编译器编译arouter有三个最重要的注解@Route、@Interceptor和@Autowired，这三个注解在编译期通过arouter-compiler这个框架生成需要的代码。
总结一下这个阶段主要就是将我们打注解的地方生成想应的代码，主要分为拦截器、route和变量
先来看RouteProc">
<meta property="og:updated_time" content="2019-12-05T07:38:49.755Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ARouter">
<meta name="twitter:description" content="arouter原理arouter有三个阶段，编译器编译、arouter初始化、arouter跳转。
编译器编译arouter有三个最重要的注解@Route、@Interceptor和@Autowired，这三个注解在编译期通过arouter-compiler这个框架生成需要的代码。
总结一下这个阶段主要就是将我们打注解的地方生成想应的代码，主要分为拦截器、route和变量
先来看RouteProc">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
  <link rel="stylesheet" href="/css/donate.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  
</head>

  
    
      <body class="dark">
    
  
      <div id="container" class="container">
        <article id="post-ARouter解析" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav class="mobile-nav">
    <h1 class="nickname">铲昶行的智障空间</h1>
    <ul class="mobile-nav-menu">
      <label for="mobile-menu-toggle"><a>&#9776; Menu</a></label>
      <input type="checkbox" id="mobile-menu-toggle"/>
      <ul class="mobile-nav-link">
        
        <a href="/">首页</a>
        
        <a href="/archives">文章</a>
        
        <a href="/tags/android">Android</a>
        
        <a href="/tags/reactnative/">ReactNative</a>
        
        <a href="/tags/leetcode">Leetcode</a>
        
        <a href="/tags/面试总结">面试总结</a>
        
      </ul>
    </ul>
  </nav>
	
		<nav id="main-nav" class="main-nav nav-left">
	
	
	  <a class="main-nav-link" href="/">首页</a>
	
	  <a class="main-nav-link" href="/archives">文章</a>
	
	  <a class="main-nav-link" href="/tags/android">Android</a>
	
	  <a class="main-nav-link" href="/tags/reactnative/">ReactNative</a>
	
	  <a class="main-nav-link" href="/tags/leetcode">Leetcode</a>
	
	  <a class="main-nav-link" href="/tags/面试总结">面试总结</a>
	
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    

    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ARouter
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <h3 id="arouter原理"><a href="#arouter原理" class="headerlink" title="arouter原理"></a>arouter原理</h3><p>arouter有三个阶段，编译器编译、arouter初始化、arouter跳转。</p>
<h4 id="编译器编译"><a href="#编译器编译" class="headerlink" title="编译器编译"></a>编译器编译</h4><p>arouter有三个最重要的注解<code>@Route</code>、<code>@Interceptor</code>和<code>@Autowired</code>，这三个注解在编译期通过arouter-compiler这个框架生成需要的代码。</p>
<p>总结一下这个阶段主要就是将我们打注解的地方生成想应的代码，主要分为拦截器、route和变量</p>
<p>先来看RouteProcesser，他的作用就是生成@Route的相关代码，生成的代码是<code>ARouter$$Group$$groupname</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Route注解用于两个地方，一个是Activity或者是Fragment，另一个是Provider。</div><div class="line"> * 对于这个类最重要的是Autowired是如何处理的，然后是怎么和activity相关联的</div><div class="line"> * Autowired放入一个map中，key为字段名，value为类型。</div><div class="line"> * 再将这个map放入另一个map，key为字段名，value为👆的map。</div><div class="line"> * 将这些东西都放到RouteMeta中</div><div class="line"> * RouteMeta再放到Set中，</div><div class="line"> * 将Set放到map中，key为group，value为set。</div><div class="line"> **/</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Map&lt;String, Set&lt;RouteMeta&gt;&gt; groupMap = <span class="keyword">new</span> HashMap&lt;&gt;(); <span class="comment">// ModuleName and routeMeta. 这个就是为了跨module。</span></div><div class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; rootMap = <span class="keyword">new</span> TreeMap&lt;&gt;();  <span class="comment">// Map of root metas, used for generate class file in order.</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line">        <span class="comment">// init方法就不看了，直接看process方法。</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> annotations</div><div class="line">     * <span class="doctag">@param</span> roundEnv</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(annotations)) &#123;</div><div class="line">            <span class="comment">// 获取所有Route注解的类，放入一个Set中。</span></div><div class="line">            Set&lt;? extends Element&gt; routeElements = roundEnv.getElementsAnnotatedWith(Route.class);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                logger.info(<span class="string">"&gt;&gt;&gt; Found routes, start... &lt;&lt;&lt;"</span>);</div><div class="line">                <span class="comment">// 进入这个方法</span></div><div class="line">                <span class="keyword">this</span>.parseRoutes(routeElements);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(e);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRoutes</span><span class="params">(Set&lt;? extends Element&gt; routeElements)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(routeElements)) &#123;</div><div class="line">            <span class="comment">// prepare the type an so on.</span></div><div class="line"></div><div class="line">            logger.info(<span class="string">"&gt;&gt;&gt; Found routes, size is "</span> + routeElements.size() + <span class="string">" &lt;&lt;&lt;"</span>);</div><div class="line"></div><div class="line">            rootMap.clear();</div><div class="line"></div><div class="line">            TypeMirror type_Activity = elements.getTypeElement(ACTIVITY).asType();</div><div class="line">            TypeMirror type_Service = elements.getTypeElement(SERVICE).asType();</div><div class="line">            TypeMirror fragmentTm = elements.getTypeElement(FRAGMENT).asType();</div><div class="line">            TypeMirror fragmentTmV4 = elements.getTypeElement(Consts.FRAGMENT_V4).asType();</div><div class="line"></div><div class="line">            <span class="comment">// Interface of ARouter</span></div><div class="line">            <span class="comment">// 这里是Group的接口的Type，IRouteGroup</span></div><div class="line">            TypeElement type_IRouteGroup = elements.getTypeElement(IROUTE_GROUP);</div><div class="line">            <span class="comment">// 这里是Provider的接口的Type，IProviderGroup</span></div><div class="line">            TypeElement type_IProviderGroup = elements.getTypeElement(IPROVIDER_GROUP);</div><div class="line">            ClassName routeMetaCn = ClassName.get(RouteMeta.class);</div><div class="line">            ClassName routeTypeCn = ClassName.get(RouteType.class);</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">               Build input type, format as :</div><div class="line"></div><div class="line">               ```Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt;</div></pre></td></tr></table></figure>
<pre><code>   和注解说的一样，用于生成传入的类型，Map&lt;String, Class&lt;? extends IRouteGroup&gt;&gt;，
   这个是给ARouter$$Root$$app用的。
 */

ParameterizedTypeName inputMapTypeOfRoot = ParameterizedTypeName.get(
        ClassName.get(Map.class),
        ClassName.get(String.class),
        ParameterizedTypeName.get(
                ClassName.get(Class.class),
                WildcardTypeName.subtypeOf(ClassName.get(type_IRouteGroup))
        )
);

/*

  <figure class="highlight plain"><figcaption><span>RouteMeta>```</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">              </div><div class="line">              同上面一样，生成Map&lt;String, RouteMeta&gt;，这是给Group和Provider使用。</div><div class="line">             */</div><div class="line">            ParameterizedTypeName inputMapTypeOfGroup = ParameterizedTypeName.get(</div><div class="line">                    ClassName.get(Map.class),</div><div class="line">                    ClassName.get(String.class),</div><div class="line">                    ClassName.get(RouteMeta.class)</div><div class="line">            );</div><div class="line"></div><div class="line">            /*</div><div class="line">              Build input param name.</div><div class="line">             */</div><div class="line">            // 这三个传值的名称。也不具体分析了</div><div class="line">            ParameterSpec rootParamSpec = ParameterSpec.builder(inputMapTypeOfRoot, &quot;routes&quot;).build();</div><div class="line">            ParameterSpec groupParamSpec = ParameterSpec.builder(inputMapTypeOfGroup, &quot;atlas&quot;).build();</div><div class="line">            ParameterSpec providerParamSpec = ParameterSpec.builder(inputMapTypeOfGroup, &quot;providers&quot;).build();  // Ps. its param type same as groupParamSpec!</div><div class="line"></div><div class="line">            /*</div><div class="line">              Build method : &apos;loadInto&apos;</div><div class="line">              </div><div class="line">              生成接口的方法loadInto</div><div class="line">             */</div><div class="line">            MethodSpec.Builder loadIntoMethodOfRootBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)</div><div class="line">                    .addAnnotation(Override.class)</div><div class="line">                    .addModifiers(PUBLIC)</div><div class="line">                    .addParameter(rootParamSpec);</div><div class="line"></div><div class="line">            //  Follow a sequence, find out metas of group first, generate java file, then statistics them as root.</div><div class="line">            // 遍历所有之前找到Route的Element。</div><div class="line">            for (Element element : routeElements) &#123;</div><div class="line">                TypeMirror tm = element.asType();</div><div class="line">                Route route = element.getAnnotation(Route.class);</div><div class="line">                RouteMeta routeMeta;</div><div class="line"></div><div class="line">                </div><div class="line">                if (types.isSubtype(tm, type_Activity)) &#123;                 // Activity</div><div class="line">                    logger.info(&quot;&gt;&gt;&gt; Found activity route: &quot; + tm.toString() + &quot; &lt;&lt;&lt;&quot;);</div><div class="line"></div><div class="line">                    // Get all fields annotation by @Autowired</div><div class="line">                    Map&lt;String, Integer&gt; paramsType = new HashMap&lt;&gt;();</div><div class="line">                    // 这个是用来放@AutoWired变量的</div><div class="line">                    Map&lt;String, Autowired&gt; injectConfig = new HashMap&lt;&gt;(); </div><div class="line">                    </div><div class="line">                    for (Element field : element.getEnclosedElements()) &#123;</div><div class="line">                        if (field.getKind().isField() &amp;&amp; field.getAnnotation(Autowired.class) != null &amp;&amp; !types.isSubtype(field.asType(), iProvider)) &#123;</div><div class="line">                            // It must be field, then it has annotation, but it not be provider.</div><div class="line">                            // 找出带Autowired且不是IProvider的变量，也就是找出Arouter框架下获取页面传输的变量</div><div class="line">                            Autowired paramConfig = field.getAnnotation(Autowired.class);</div><div class="line">                            // Autowired(name=&quot;&quot;)，这里用来获取是否有在注解里设置的名字，没有的话用变量名</div><div class="line">                            String injectName = StringUtils.isEmpty(paramConfig.name()) ? field.getSimpleName().toString() : paramConfig.name();</div><div class="line">                            // 将这个这个变量处理一下放入paramsType的map中，key为注解的名字，value是类型</div><div class="line">                            paramsType.put(injectName, typeUtils.typeExchange(field));</div><div class="line">                            // 将paramsType放入injectConfig的map中，key为注解的名字，value为paramsType</div><div class="line">                            injectConfig.put(injectName, paramConfig);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    // 将关于ACTIVITY的内容放到RouteMeta这个类中</div><div class="line">                    routeMeta = new RouteMeta(route, element, RouteType.ACTIVITY, paramsType);</div><div class="line">                    // 将拥有变量信息的injectConfig放到RRouteMeta中</div><div class="line">                    routeMeta.setInjectConfig(injectConfig);</div><div class="line">                &#125; else if (types.isSubtype(tm, iProvider)) &#123;         // IProvider</div><div class="line">                    logger.info(&quot;&gt;&gt;&gt; Found provider route: &quot; + tm.toString() + &quot; &lt;&lt;&lt;&quot;);</div><div class="line">                    routeMeta = new RouteMeta(route, element, RouteType.PROVIDER, null);</div><div class="line">                &#125; else if (types.isSubtype(tm, type_Service)) &#123;           // Service</div><div class="line">                    logger.info(&quot;&gt;&gt;&gt; Found service route: &quot; + tm.toString() + &quot; &lt;&lt;&lt;&quot;);</div><div class="line">                    routeMeta = new RouteMeta(route, element, RouteType.parse(SERVICE), null);</div><div class="line">                &#125; else if (types.isSubtype(tm, fragmentTm) || types.isSubtype(tm, fragmentTmV4)) &#123;</div><div class="line">                    logger.info(&quot;&gt;&gt;&gt; Found fragment route: &quot; + tm.toString() + &quot; &lt;&lt;&lt;&quot;);</div><div class="line">                    routeMeta = new RouteMeta(route, element, RouteType.parse(FRAGMENT), null);</div><div class="line">                &#125; else &#123;</div><div class="line">                    // 这里可以得出结论，Route只能在Activity，Fragment，Service和Provider使用，不然就会报错</div><div class="line">                    throw new RuntimeException(&quot;ARouter::Compiler &gt;&gt;&gt; Found unsupported class type, type = [&quot; + types.toString() + &quot;].&quot;);</div><div class="line">                &#125;</div><div class="line">                // 这个方法就不深入了，groupMap是一个group为key，routeMetaSet为value的map，而routeMetaSet是存放RouteMeta的一个Set。这个方法的作用就是将我们这里已经创建好的RouteMeta放入routeMetaSet中</div><div class="line">                categories(routeMeta);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            MethodSpec.Builder loadIntoMethodOfProviderBuilder = MethodSpec.methodBuilder(METHOD_LOAD_INTO)</div><div class="line">                    .addAnnotation(Override.class)</div><div class="line">                    .addModifiers(PUBLIC)</div><div class="line">                    .addParameter(providerParamSpec);</div><div class="line"></div><div class="line">            Map&lt;String, List&lt;RouteDoc&gt;&gt; docSource = new HashMap&lt;&gt;();</div><div class="line"></div><div class="line">            // Start generate java source, structure is divided into upper and lower levels, used for demand initialization.</div><div class="line">            // 这里就开始生成代码了，这里的操作其实就有点机械化了，也就是没啥意思了，可以直接看生成类了。</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><p>接下来是AutowiredProcessor，用来生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.alibaba.android.arouter.compiler.processor;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Processor used to create autowired helper</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> zhilong &lt;a href="mailto:zhilong.lzl@alibaba-inc.com"&gt;Contact me.&lt;/a&gt;</div><div class="line"> * <span class="doctag">@version</span> 1.0</div><div class="line"> * <span class="doctag">@since</span> 2017/2/20 下午5:56</div><div class="line"> */</div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="meta">@SupportedOptions</span>(KEY_MODULE_NAME)</div><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.RELEASE_7)</div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123;ANNOTATION_TYPE_AUTOWIRED&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutowiredProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Map&lt;TypeElement, List&lt;Element&gt;&gt; parentAndChild = <span class="keyword">new</span> HashMap&lt;&gt;();   <span class="comment">// Contain field need autowired and his super class.</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassName ARouterClass = ClassName.get(<span class="string">"com.alibaba.android.arouter.launcher"</span>, <span class="string">"ARouter"</span>);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassName AndroidLog = ClassName.get(<span class="string">"android.util"</span>, <span class="string">"Log"</span>);</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(processingEnvironment);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(set)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                logger.info(<span class="string">"&gt;&gt;&gt; Found autowired field, start... &lt;&lt;&lt;"</span>);</div><div class="line">                <span class="comment">// 这个方法将Autowired和Activity相关联，将所有同一个Activity中的Autowired放入一个列表，再放入一个map，key为所在类的名字，value为列表，这里有个判断，如果Autowired为private，则直接报错</span></div><div class="line">                categories(roundEnvironment.getElementsAnnotatedWith(Autowired.class));</div><div class="line">                generateHelper();</div><div class="line"></div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(e);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateHelper</span><span class="params">()</span> <span class="keyword">throws</span> IOException, IllegalAccessException </span>&#123;</div><div class="line">        TypeElement type_ISyringe = elements.getTypeElement(ISYRINGE);</div><div class="line">        </div><div class="line">        <span class="comment">// 这个是专门用给通过JSON来序列化Object传值的</span></div><div class="line">        TypeElement type_JsonService = elements.getTypeElement(JSON_SERVICE);</div><div class="line">        TypeMirror iProvider = elements.getTypeElement(Consts.IPROVIDER).asType();</div><div class="line">        TypeMirror activityTm = elements.getTypeElement(Consts.ACTIVITY).asType();</div><div class="line">        TypeMirror fragmentTm = elements.getTypeElement(Consts.FRAGMENT).asType();</div><div class="line">        TypeMirror fragmentTmV4 = elements.getTypeElement(Consts.FRAGMENT_V4).asType();</div><div class="line"></div><div class="line">        <span class="comment">// Build input param name.</span></div><div class="line">        <span class="comment">// 传入的变量名</span></div><div class="line">        ParameterSpec objectParamSpec = ParameterSpec.builder(TypeName.OBJECT, <span class="string">"target"</span>).build();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (MapUtils.isNotEmpty(parentAndChild)) &#123;</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;TypeElement, List&lt;Element&gt;&gt; entry : parentAndChild.entrySet()) &#123;</div><div class="line">                <span class="comment">// 这里省略了一些生成代码，并没有什么具体逻辑</span></div><div class="line"></div><div class="line">                <span class="comment">// Generate method body, start inject.</span></div><div class="line">                <span class="keyword">for</span> (Element element : childs) &#123;</div><div class="line">                    Autowired fieldConfig = element.getAnnotation(Autowired.class);</div><div class="line">                    String fieldName = element.getSimpleName().toString();</div><div class="line">                    <span class="comment">// 这里有区分IProvider和其他类型</span></div><div class="line">                    <span class="keyword">if</span> (types.isSubtype(element.asType(), iProvider)) &#123;  <span class="comment">// It's provider</span></div><div class="line">                        <span class="keyword">if</span> (<span class="string">""</span>.equals(fieldConfig.name())) &#123;    <span class="comment">// User has not set service path, then use byType.</span></div><div class="line"></div><div class="line">                            <span class="comment">// Getter</span></div><div class="line">                            injectMethodBuilder.addStatement(</div><div class="line">                                    <span class="string">"substitute."</span> + fieldName + <span class="string">" = $T.getInstance().navigation($T.class)"</span>,</div><div class="line">                                    ARouterClass,</div><div class="line">                                    ClassName.get(element.asType())</div><div class="line">                            );</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;    <span class="comment">// use byName</span></div><div class="line">                            <span class="comment">// Getter</span></div><div class="line">                            injectMethodBuilder.addStatement(</div><div class="line">                                    <span class="string">"substitute."</span> + fieldName + <span class="string">" = ($T)$T.getInstance().build($S).navigation()"</span>,</div><div class="line">                                    ClassName.get(element.asType()),</div><div class="line">                                    ARouterClass,</div><div class="line">                                    fieldConfig.name()</div><div class="line">                            );</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// Validater 这里有个逻辑，如果@Autowired(required=true)，则在代码生成的时候加入非空判断</span></div><div class="line">                        <span class="keyword">if</span> (fieldConfig.required()) &#123;</div><div class="line">                            injectMethodBuilder.beginControlFlow(<span class="string">"if (substitute."</span> + fieldName + <span class="string">" == null)"</span>);</div><div class="line">                            injectMethodBuilder.addStatement(</div><div class="line">                                    <span class="string">"throw new RuntimeException(\"The field '"</span> + fieldName + <span class="string">"' is null, in class '\" + $T.class.getName() + \"!\")"</span>, ClassName.get(parent));</div><div class="line">                            injectMethodBuilder.endControlFlow();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// It's normal intent value</span></div><div class="line">                        String originalValue = <span class="string">"substitute."</span> + fieldName;</div><div class="line">                        String statement = <span class="string">"substitute."</span> + fieldName + <span class="string">" = "</span> + buildCastCode(element) + <span class="string">"substitute."</span>;</div><div class="line">                        <span class="keyword">boolean</span> isActivity = <span class="keyword">false</span>;</div><div class="line">                        <span class="keyword">if</span> (types.isSubtype(parent.asType(), activityTm)) &#123;  <span class="comment">// Activity, then use getIntent()</span></div><div class="line">                            isActivity = <span class="keyword">true</span>;</div><div class="line">                            statement += <span class="string">"getIntent()."</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (types.isSubtype(parent.asType(), fragmentTm) || types.isSubtype(parent.asType(), fragmentTmV4)) &#123;   <span class="comment">// Fragment, then use getArguments()</span></div><div class="line">                            statement += <span class="string">"getArguments()."</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalAccessException(<span class="string">"The field ["</span> + fieldName + <span class="string">"] need autowired from intent, its parent must be activity or fragment!"</span>);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// buildStatement方法用来生成获取变量的代码，这里面有一种传值是通过json来传递Object，需要实现一个serializationService，这个类专门给我们实现Json的解析</span></div><div class="line">                        statement = buildStatement(originalValue, statement, typeUtils.typeExchange(element), isActivity);</div><div class="line">                        <span class="keyword">if</span> (statement.startsWith(<span class="string">"serializationService."</span>)) &#123;   <span class="comment">// Not mortals</span></div><div class="line">                            injectMethodBuilder.beginControlFlow(<span class="string">"if (null != serializationService)"</span>);</div><div class="line">                            injectMethodBuilder.addStatement(</div><div class="line">                                    <span class="string">"substitute."</span> + fieldName + <span class="string">" = "</span> + statement,</div><div class="line">                                    (StringUtils.isEmpty(fieldConfig.name()) ? fieldName : fieldConfig.name()),</div><div class="line">                                    ClassName.get(element.asType())</div><div class="line">                            );</div><div class="line">                            injectMethodBuilder.nextControlFlow(<span class="string">"else"</span>);</div><div class="line">                            injectMethodBuilder.addStatement(</div><div class="line">                                    <span class="string">"$T.e(\""</span> + Consts.TAG + <span class="string">"\", \"You want automatic inject the field '"</span> + fieldName + <span class="string">"' in class '$T' , then you should implement 'SerializationService' to support object auto inject!\")"</span>, AndroidLog, ClassName.get(parent));</div><div class="line">                            injectMethodBuilder.endControlFlow();</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            injectMethodBuilder.addStatement(statement, StringUtils.isEmpty(fieldConfig.name()) ? fieldName : fieldConfig.name());</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// Validator</span></div><div class="line">                        <span class="comment">// 这里也一样，有一个required的判断</span></div><div class="line">                        <span class="keyword">if</span> (fieldConfig.required() &amp;&amp; !element.asType().getKind().isPrimitive()) &#123;  <span class="comment">// Primitive wont be check.</span></div><div class="line">                            injectMethodBuilder.beginControlFlow(<span class="string">"if (null == substitute."</span> + fieldName + <span class="string">")"</span>);</div><div class="line">                            injectMethodBuilder.addStatement(</div><div class="line">                                    <span class="string">"$T.e(\""</span> + Consts.TAG + <span class="string">"\", \"The field '"</span> + fieldName + <span class="string">"' is null, in class '\" + $T.class.getName() + \"!\")"</span>, AndroidLog, ClassName.get(parent));</div><div class="line">                            injectMethodBuilder.endControlFlow();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                helper.addMethod(injectMethodBuilder.build());</div><div class="line"></div><div class="line">                <span class="comment">// Generate autowire helper</span></div><div class="line">                JavaFile.builder(packageName, helper.build()).build().writeTo(mFiler);</div><div class="line"></div><div class="line">                logger.info(<span class="string">"&gt;&gt;&gt; "</span> + parent.getSimpleName() + <span class="string">" has been processed, "</span> + fileName + <span class="string">" has been generated. &lt;&lt;&lt;"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            logger.info(<span class="string">"&gt;&gt;&gt; Autowired processor stop. &lt;&lt;&lt;"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">buildStatement</span><span class="params">(String originalValue, String statement, <span class="keyword">int</span> type, <span class="keyword">boolean</span> isActivity)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (type == TypeKind.BOOLEAN.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getBooleanExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getBoolean($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.BYTE.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getByteExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getByte($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.SHORT.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getShortExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getShort($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.INT.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getIntExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getInt($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.LONG.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getLongExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getLong($S)"</span>));</div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type == TypeKind.CHAR.ordinal())&#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getCharExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getChar($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.FLOAT.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getFloatExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getFloat($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.DOUBLE.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getDoubleExtra($S, "</span> + originalValue + <span class="string">")"</span>) : (<span class="string">"getDouble($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.STRING.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getStringExtra($S)"</span>) : (<span class="string">"getString($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.SERIALIZABLE.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getSerializableExtra($S)"</span>) : (<span class="string">"getSerializable($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.PARCELABLE.ordinal()) &#123;</div><div class="line">            statement += (isActivity ? (<span class="string">"getParcelableExtra($S)"</span>) : (<span class="string">"getParcelable($S)"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == TypeKind.OBJECT.ordinal()) &#123;</div><div class="line">            statement = <span class="string">"serializationService.parseObject(substitute."</span> + (isActivity ? <span class="string">"getIntent()."</span> : <span class="string">"getArguments()."</span>) + (isActivity ? <span class="string">"getStringExtra($S)"</span> : <span class="string">"getString($S)"</span>) + <span class="string">", new com.alibaba.android.arouter.facade.model.TypeWrapper&lt;$T&gt;()&#123;&#125;.getType())"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> statement;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来是InterceptorProcessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.alibaba.android.arouter.compiler.processor;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Process the annotation of #&#123;<span class="doctag">@link</span> Interceptor&#125;</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> Alex &lt;a href="mailto:zhilong.liu@aliyun.com"&gt;Contact me.&lt;/a&gt;</div><div class="line"> * <span class="doctag">@version</span> 1.0</div><div class="line"> * <span class="doctag">@since</span> 16/8/23 14:11</div><div class="line"> */</div><div class="line"><span class="meta">@AutoService</span>(Processor.class)</div><div class="line"><span class="meta">@SupportedOptions</span>(KEY_MODULE_NAME)</div><div class="line"><span class="meta">@SupportedSourceVersion</span>(SourceVersion.RELEASE_7)</div><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(ANNOTATION_TYPE_INTECEPTOR)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InterceptorProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Map&lt;Integer, Element&gt; interceptors = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Initializes the processor with the processing environment by</div><div class="line">     * setting the &#123;<span class="doctag">@code</span> processingEnv&#125; field to the value of the</div><div class="line">     * &#123;<span class="doctag">@code</span> processingEnv&#125; argument.  An &#123;<span class="doctag">@code</span></div><div class="line">     * IllegalStateException&#125; will be thrown if this method is called</div><div class="line">     * more than once on the same object.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> processingEnv environment to access facilities the tool framework</div><div class="line">     *                      provides to the processor</div><div class="line">     * <span class="doctag">@throws</span> IllegalStateException if this method is called more than once.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> annotations</div><div class="line">     * <span class="doctag">@param</span> roundEnv</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(annotations)) &#123;</div><div class="line">            Set&lt;? extends Element&gt; elements = roundEnv.getElementsAnnotatedWith(Interceptor.class);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 直接看这个方法</span></div><div class="line">                parseInterceptors(elements);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.error(e);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Parse tollgate.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> elements elements of tollgate.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseInterceptors</span><span class="params">(Set&lt;? extends Element&gt; elements)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(elements)) &#123;</div><div class="line">            logger.info(<span class="string">"&gt;&gt;&gt; Found interceptors, size is "</span> + elements.size() + <span class="string">" &lt;&lt;&lt;"</span>);</div><div class="line"></div><div class="line">            <span class="comment">// Verify and cache, sort incidentally.</span></div><div class="line">            <span class="keyword">for</span> (Element element : elements) &#123;</div><div class="line">                <span class="keyword">if</span> (verify(element)) &#123;  <span class="comment">// Check the interceptor meta 判断是不是拦截器的标准写法</span></div><div class="line">                    logger.info(<span class="string">"A interceptor verify over, its "</span> + element.asType());</div><div class="line">                    Interceptor interceptor = element.getAnnotation(Interceptor.class);</div><div class="line"></div><div class="line">                    Element lastInterceptor = interceptors.get(interceptor.priority());</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != lastInterceptor) &#123; <span class="comment">// Added, throw exceptions， 如果优先级相同的拦截器会直接报错</span></div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                                String.format(Locale.getDefault(), <span class="string">"More than one interceptors use same priority [%d], They are [%s] and [%s]."</span>,</div><div class="line">                                        interceptor.priority(),</div><div class="line">                                        lastInterceptor.getSimpleName(),</div><div class="line">                                        element.getSimpleName())</div><div class="line">                        );</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    interceptors.put(interceptor.priority(), element);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    logger.error(<span class="string">"A interceptor verify failed, its "</span> + element.asType());</div><div class="line">                &#125;</div><div class="line">              </div><div class="line">                <span class="comment">// 后面只是生成的代码，没有什么值得注意的逻辑</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此编译器编译的内容结束了，接下来我们来看看关于Arouter初始化做了啥。</p>
<p>1.将生成的类放入Warehouse想对应的列表中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * Init, it must be call before used router.</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!hasInit) &#123;</div><div class="line">        logger = _ARouter.logger;</div><div class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init start."</span>);</div><div class="line">        <span class="comment">// init核心代码就是这个</span></div><div class="line">        hasInit = _ARouter.init(application);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (hasInit) &#123;</div><div class="line">            <span class="comment">// 这里是init唯二重要的另一个点</span></div><div class="line">          	_ARouter.afterInit();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        _ARouter.logger.info(Consts.TAG, <span class="string">"ARouter init over."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ARouter</span> </span>&#123;</div><div class="line">    <span class="comment">// 这里创建了个线程池</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> ThreadPoolExecutor executor = DefaultPoolExecutor.getInstance();</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</div><div class="line">        mContext = application;</div><div class="line">        <span class="comment">// init的内容都在这里</span></div><div class="line">        LogisticsCenter.init(mContext, executor);</div><div class="line">        logger.info(Consts.TAG, <span class="string">"ARouter init success!"</span>);</div><div class="line">        hasInit = <span class="keyword">true</span>;</div><div class="line">        <span class="comment">// 这里创建了一个在主线程的handler</span></div><div class="line">        mHandler = <span class="keyword">new</span> Handler(Looper.getMainLooper());</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogisticsCenter</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * LogisticsCenter init, load all metas in memory. Demand initialization</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, ThreadPoolExecutor tpe)</span> <span class="keyword">throws</span> HandlerException </span>&#123;</div><div class="line">        mContext = context;</div><div class="line">        executor = tpe;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">long</span> startInit = System.currentTimeMillis();</div><div class="line">            <span class="comment">//billy.qi modified at 2017-12-06</span></div><div class="line">            <span class="comment">//load by plugin first</span></div><div class="line">            loadRouterMap();</div><div class="line">            <span class="keyword">if</span> (registerByPlugin) &#123;</div><div class="line">                logger.info(TAG, <span class="string">"Load router map by arouter-auto-register plugin."</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Set&lt;String&gt; routerMap;</div><div class="line"></div><div class="line">                <span class="comment">// It will rebuild router map every times when debuggable.</span></div><div class="line">                <span class="keyword">if</span> (ARouter.debuggable() || PackageUtils.isNewVersion(context)) &#123;</div><div class="line">                    logger.info(TAG, <span class="string">"Run with debug mode or new install, rebuild router map."</span>);</div><div class="line">                    <span class="comment">// These class was generated by arouter-compiler.</span></div><div class="line">                    <span class="comment">// 获取所有生成package下面的类</span></div><div class="line">                    routerMap = ClassUtils.getFileNameByPackageName(mContext, ROUTE_ROOT_PAKCAGE);</div><div class="line">                    <span class="keyword">if</span> (!routerMap.isEmpty()) &#123;</div><div class="line">                        context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).edit().putStringSet(AROUTER_SP_KEY_MAP, routerMap).apply();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    PackageUtils.updateVersion(context);    <span class="comment">// Save new version name when router map update finishes.</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    logger.info(TAG, <span class="string">"Load router map from cache."</span>);</div><div class="line">                    routerMap = <span class="keyword">new</span> HashSet&lt;&gt;(context.getSharedPreferences(AROUTER_SP_CACHE_KEY, Context.MODE_PRIVATE).getStringSet(AROUTER_SP_KEY_MAP, <span class="keyword">new</span> HashSet&lt;String&gt;()));</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                logger.info(TAG, <span class="string">"Find router map finished, map size = "</span> + routerMap.size() + <span class="string">", cost "</span> + (System.currentTimeMillis() - startInit) + <span class="string">" ms."</span>);</div><div class="line">                startInit = System.currentTimeMillis();</div><div class="line"> 								<span class="comment">// 将拿到的class放到相应的Warehouse的列表中</span></div><div class="line">                <span class="keyword">for</span> (String className : routerMap) &#123;</div><div class="line">                    <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_ROOT)) &#123;</div><div class="line">                        <span class="comment">// This one of root elements, load root.</span></div><div class="line">                        ((IRouteRoot) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.groupsIndex);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_INTERCEPTORS)) &#123;</div><div class="line">                        <span class="comment">// Load interceptorMeta</span></div><div class="line">                        ((IInterceptorGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.interceptorsIndex);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(ROUTE_ROOT_PAKCAGE + DOT + SDK_NAME + SEPARATOR + SUFFIX_PROVIDERS)) &#123;</div><div class="line">                        <span class="comment">// Load providerIndex</span></div><div class="line">                        ((IProviderGroup) (Class.forName(className).getConstructor().newInstance())).loadInto(Warehouse.providersIndex);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 下面都是一些无用的操作</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2019/12/02/ARouter解析/" class="article-date">
  <time datetime="2019-12-02T09:52:12.000Z" itemprop="datePublished">2019-12-02</time>
</a>

        </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2019/12/03/looper/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          looper
        
      </div>
    </a>
  
  
    <a href="/2019/04/30/RecyclerView源码解析/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">RecyclerView源码解析</div>
    </a>
  
</nav>


  
</article>










      </div>
      
    <footer id="footer" class="post-footer footer">
      
        <ul class="footer-links">
          
            <li><a href="/archives/"><span class="fa fa-book"></span></a></li>
          
            <li><a href="https://github.com/chanchangxing"><span class="fa fa-globe"></span></a></li>
          
        </ul>
	    
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>这篇写完就删站</p>


      </div>
    </footer>

      







<script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3/dist/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
