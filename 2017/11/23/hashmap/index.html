<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  
  <title>hashmap | Flog&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="hashmap最基础的使用方法如下，我们根据使用方法来分析hashmap源码
123HashMap&amp;lt;String, String&amp;gt; hashMap = new HashMap&amp;lt;&amp;gt;();hashMap.put(&quot;a&quot;, &quot;1&quot;);hashMap.get(&quot;a&quot;);
我们先来看HashMap的构造函数
1234public HashMap() &amp;#123;  	//这是一个加载">
<meta property="og:type" content="article">
<meta property="og:title" content="hashmap">
<meta property="og:url" content="https://chanchangxing.me/2017/11/23/hashmap/index.html">
<meta property="og:site_name" content="Flog'blog">
<meta property="og:description" content="hashmap最基础的使用方法如下，我们根据使用方法来分析hashmap源码
123HashMap&amp;lt;String, String&amp;gt; hashMap = new HashMap&amp;lt;&amp;gt;();hashMap.put(&quot;a&quot;, &quot;1&quot;);hashMap.get(&quot;a&quot;);
我们先来看HashMap的构造函数
1234public HashMap() &amp;#123;  	//这是一个加载">
<meta property="og:updated_time" content="2017-12-08T08:08:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hashmap">
<meta name="twitter:description" content="hashmap最基础的使用方法如下，我们根据使用方法来分析hashmap源码
123HashMap&amp;lt;String, String&amp;gt; hashMap = new HashMap&amp;lt;&amp;gt;();hashMap.put(&quot;a&quot;, &quot;1&quot;);hashMap.get(&quot;a&quot;);
我们先来看HashMap的构造函数
1234public HashMap() &amp;#123;  	//这是一个加载">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
  <link rel="stylesheet" href="/css/donate.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  
</head>

  
    
      <body class="dark">
    
  
      <div id="container" class="container">
        <article id="post-hashmap" class="article article-type-post" itemscope itemprop="blogPost">
  <header id="header" class="header">
  <nav class="mobile-nav">
    <h1 class="nickname">铲昶行的智障空间</h1>
    <ul class="mobile-nav-menu">
      <label for="mobile-menu-toggle"><a>&#9776; Menu</a></label>
      <input type="checkbox" id="mobile-menu-toggle"/>
      <ul class="mobile-nav-link">
        
        <a href="/">Home</a>
        
        <a href="/archives">Archives</a>
        
        <a href="/tags/android">Android</a>
        
        <a href="/tags/reactnative/">ReactNative</a>
        
        <a href="/tags/leetcode">Leetcode</a>
        
        <a href="/tags/javascript">JavaScript</a>
        
      </ul>
    </ul>
  </nav>
	
		<nav id="main-nav" class="main-nav nav-left">
	
	
	  <a class="main-nav-link" href="/">Home</a>
	
	  <a class="main-nav-link" href="/archives">Archives</a>
	
	  <a class="main-nav-link" href="/tags/android">Android</a>
	
	  <a class="main-nav-link" href="/tags/reactnative/">ReactNative</a>
	
	  <a class="main-nav-link" href="/tags/leetcode">Leetcode</a>
	
	  <a class="main-nav-link" href="/tags/javascript">JavaScript</a>
	
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    

    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      hashmap
    </h1>
  

      </header>
    
    <div class="article-entry typo" itemprop="articleBody">
      
        <p>hashmap最基础的使用方法如下，我们根据使用方法来分析hashmap源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HashMap&lt;String, String&gt; hashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">hashMap.put(<span class="string">"a"</span>, <span class="string">"1"</span>);</div><div class="line">hashMap.get(<span class="string">"a"</span>);</div></pre></td></tr></table></figure>
<p>我们先来看HashMap的构造函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</div><div class="line">  	<span class="comment">//这是一个加载因子，目前还不清楚他的作用</span></div><div class="line">	<span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>put方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们首先来看一看hash()这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> h;</div><div class="line">	<span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哈哈，我**的想笑死，看到这串简单的代码我竟然懵逼了，可见我的java基础有多差</p>
<p><code>^</code>异或操作符，规则是：两个操作数的位中，相同则结果为0，不同结果为1，直接上实例代码吧</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a1 = <span class="number">11</span>;</div><div class="line"><span class="keyword">int</span> a2 = <span class="number">13</span>;</div><div class="line">System.out.println(a1 ^ a2);</div><div class="line"></div><div class="line"><span class="comment">//output: 6</span></div><div class="line"><span class="comment">//11的二进制为1011，13的二进制为1101</span></div><div class="line"><span class="comment">// 1011 ^ 1101 == 0110</span></div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt;</code>是无符号右移换位符，右移之后补位全为0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a = <span class="number">16</span>;</div><div class="line">System.out.println(a &gt;&gt;&gt; <span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">//output: 8</span></div><div class="line"><span class="comment">//16的二进制为10000</span></div><div class="line"><span class="comment">//10000 &gt;&gt;&gt; 1000</span></div></pre></td></tr></table></figure>
<p>现在关键是这个hashcode()了，但是hashcode()是native方法，只能从百度里面看看到底是什么了。</p>
<p>经过一个晚上粗略查找，貌似没有人知道这个问题，所以我们直接来看这段代码<code>(key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16)</code>的意义吧，我先贴个<a href="https://www.zhihu.com/question/51784530" target="_blank" rel="external">链接</a>，大概的意思就是hashcode二进制位数较高，而较低位置都为0，而hashmap在计算index的时候只会去计算低位，这样的话就会发生hash碰撞，在我以前的印象中这个东西后面会显示出他的作用。</p>
<p>接下来我们来分析👆代码中的putVal方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent, <span class="keyword">boolean</span> evict)</span> </span>&#123;</div><div class="line">	Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line">	<span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">      	<span class="comment">//这里的resize()是用来初始化或者增加表的大小的，从if逻辑判断来看，我们这里用到的应该是初始化。</span></div><div class="line">      	<span class="comment">//所以我接下来就展示resize()初始化的代码。</span></div><div class="line">		n = (tab = resize()).length;</div><div class="line">	<span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">		tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		Node&lt;K,V&gt; e; K k;</div><div class="line">         <span class="keyword">if</span> (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">			e = p;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line">			e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">				<span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">					p.next = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">					<span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">						treeifyBin(tab, hash);</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				p = e;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line">			V oldValue = e.value;</div><div class="line">			<span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">				e.value = value;</div><div class="line">			afterNodeAccess(e);</div><div class="line">			<span class="keyword">return</span> oldValue;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	++modCount;</div><div class="line">	<span class="keyword">if</span> (++size &gt; threshold)</div><div class="line">		resize();</div><div class="line">	afterNodeInsertion(evict);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里是resize初始化部分的代码，可以从下面的结果知道初试话返回的是一个长度为16的Node数列，然后定义了一下全局变量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16 结果为16</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>; <span class="comment">//结果为1073741824</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</div><div class="line">	Node&lt;K,V&gt;[] oldTab = table;</div><div class="line">	<span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length; <span class="comment">//因为没有初始化，所以oldCap为0</span></div><div class="line">	<span class="keyword">int</span> oldThr = threshold; <span class="comment">//为0</span></div><div class="line">	<span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</div><div class="line">  	</div><div class="line">  	<span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">//oldCap是0，省略</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>)</div><div class="line">		<span class="comment">//oldThr是0，省略</span></div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		newCap = DEFAULT_INITIAL_CAPACITY;</div><div class="line">		newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY); <span class="comment">//结果为12</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</div><div class="line">		<span class="comment">//newThr不为0，省略</span></div><div class="line">	&#125;</div><div class="line">	threshold = newThr;</div><div class="line">	<span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</div><div class="line">	Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</div><div class="line">	table = newTab;</div><div class="line">  	</div><div class="line">  	<span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="comment">//oldTab 为空 省略</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> newTab;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以再回到putVal方法中，这里我们只展示初始化的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent, <span class="keyword">boolean</span> evict)</span> </span>&#123;</div><div class="line">	Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line">	<span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">		<span class="comment">//我们是分析初始化，所以这里n为16</span></div><div class="line">		n = (tab = resize()).length;</div><div class="line">	<span class="comment">//&amp;和前面解释的^差不多，操作位两个都为1为1，其余都为0</span></div><div class="line">  	<span class="comment">//关键是这个hash我不清楚他是个怎么样的结果</span></div><div class="line">  	<span class="comment">//但是因为Node数组只是进行了实例，往里面加什么东西，所以还是能肯定p==null是为true的</span></div><div class="line">	<span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">		<span class="comment">//下面要看看newNode方法</span></div><div class="line">		tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">	<span class="keyword">else</span> &#123;s</div><div class="line">    	<span class="comment">//省略...</span></div><div class="line">    &#125;</div><div class="line">  	++modCount;</div><div class="line">  	<span class="comment">//初试话的话size才为1，所以不会走到resize()</span></div><div class="line">	<span class="keyword">if</span> (++size &gt; threshold)</div><div class="line">		resize();</div><div class="line">  	<span class="comment">//这是为LinkedHashMap设计的方法，我们先放一放吧。</span></div><div class="line">	afterNodeInsertion(evict);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是Node的代码，其他都很简单，我们也知道了传说中的Entry，关键是看到构造方法next参数，说不定他就是我在《Java编程思想》中看到的末尾哨兵..</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">	Node(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">		<span class="keyword">this</span>.hash = hash;</div><div class="line">		<span class="keyword">this</span>.key = key;</div><div class="line">		<span class="keyword">this</span>.value = value;</div><div class="line">		<span class="keyword">this</span>.next = next;</div><div class="line">	&#125;	</div><div class="line">  </div><div class="line">  	<span class="function">Node&lt;K,V&gt; <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Node&lt;&gt;(hash, key, value, next);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初试话的put已经分析ok，下面我们来看看get方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">	Node&lt;K,V&gt; e;</div><div class="line">  	<span class="comment">//hash方法是一样的，所以我们直接看getNode方法吧。</span></div><div class="line">	<span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</div><div class="line">	Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</div><div class="line">	<span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp; (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></div><div class="line">         <span class="comment">//== 和 equals，可能是针对于String和开发者自己定义了equals的情况吧。</span></div><div class="line">		((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">			<span class="keyword">return</span> first;</div><div class="line">		<span class="comment">//..目前为初始化状态，所以省略</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有两点想法：</p>
<p>1.我们可以通过<code>if ((p = tab[i = (n - 1) &amp; hash]) == null)</code>来反推一下hashcode大概的值。我们从上面的代码的计算可以知道，tab这个Node[]的初始长度为16，然后 <code>(n - 1) &amp;hash</code></p>
<p>​    所以推算一下-1的二进制: 1 —&gt; 1111111111111111111111111111110 —&gt; 1111111111111111111111111111111。得出结论了，与 <code>(n - 1) &amp;hash = hash</code>。</p>
<p>让我们回到之前，那行代码可以简化成<code>(p = tab[i = hash])</code>，tab[]的长度为16，也就是说hash的范围肯定是0-15，不然就会数组越界，而15的二进制是1111……..推不出来了，停住了….待续</p>
<p>2.之前对于hashmap的认识，知道他是一个桶里是放着LinkedList的，但是这里<code>tab[i] = newNode(hash, key, value, null);</code>放入是一个Node类，看来之后对于相同的index才会做这样的操作，不知道是不是。</p>
<p>现在是第二次操作了，我们再按照流程走一波</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent, <span class="keyword">boolean</span> evict)</span> </span>&#123;</div><div class="line">	Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</div><div class="line">  	<span class="comment">//tab 和 n 竟然在这里定义值，真是搞不懂</span></div><div class="line">	<span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</div><div class="line">		n = (tab = resize()).length;</div><div class="line">	<span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</div><div class="line">		<span class="comment">//所以这里就被省略啦，但是p在if中定义了，也要注意</span></div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		Node&lt;K,V&gt; e; K k;</div><div class="line">		<span class="keyword">if</span> (p.hash == hash &amp;&amp; </div><div class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">			<span class="comment">//这里是put到了正好是对的Entity，而除了这个之外的逻辑都是因为hash碰撞了。</span></div><div class="line">			e = p;</div><div class="line">    	<span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</div><div class="line">			<span class="comment">//这里是p采用了红黑树，对数据结构真的不了解，了解了再来分析这个</span></div><div class="line">			e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">//这里是p采用了单链，先分析这个</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</div><div class="line">				<span class="comment">//如果p的next为空的话，那么就把Node放到p的next里</span></div><div class="line">				<span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">					p.next = newNode(hash, key, value, <span class="keyword">null</span>);</div><div class="line">					<span class="comment">//如果这个bucket的链超过7个的话，那么就调用treeifyBin方法</span></div><div class="line">					<span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></div><div class="line">						treeifyBin(tab, hash);</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">//“如果有相同的hash和key，则退出循环”，说明已经找到通过有相同key的Entity了</span></div><div class="line">				<span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				p = e;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//这里发生的情况就是找到了相同了key的Entity，然后把value替换就好。</span></div><div class="line">		<span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></div><div class="line">			V oldValue = e.value;</div><div class="line">			<span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</div><div class="line">				e.value = value;</div><div class="line">			afterNodeAccess(e);</div><div class="line">			<span class="keyword">return</span> oldValue;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  	++modCount;</div><div class="line">	<span class="keyword">if</span> (++size &gt; threshold)</div><div class="line">		resize();</div><div class="line">	afterNodeInsertion(evict);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面treeifyBin方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> n, index; Node&lt;K,V&gt; e;</div><div class="line">	<span class="comment">//如果tab的长度小于64的话，那就只对tab进行扩张</span></div><div class="line">	<span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</div><div class="line">		resize();</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</div><div class="line">		TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">do</span> &#123;</div><div class="line">			TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</div><div class="line">			<span class="keyword">if</span> (tl == <span class="keyword">null</span>)</div><div class="line">				hd = p;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				p.prev = tl;</div><div class="line">				tl.next = p;</div><div class="line">			&#125;</div><div class="line">			tl = p;</div><div class="line">		&#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</div><div class="line">		<span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</div><div class="line">			hd.treeify(tab);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>按照现在的能力，我们还是先看扩张吧。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</div><div class="line">	Node&lt;K,V&gt;[] oldTab = table;</div><div class="line">	<span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</div><div class="line">	<span class="keyword">int</span> oldThr = threshold;</div><div class="line">	<span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</div><div class="line">			<span class="comment">//...省略</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">//这里将数组的大小扩充一倍，把阈增加一倍</span></div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</div><div class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</div><div class="line">			newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></div><div class="line">		&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></div><div class="line">		newCap = oldThr;</div><div class="line">	<span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></div><div class="line">		newCap = DEFAULT_INITIAL_CAPACITY;</div><div class="line">		newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</div><div class="line">		<span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</div><div class="line">		newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</div><div class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</div><div class="line">	&#125;</div><div class="line">	threshold = newThr;</div><div class="line">	<span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</div><div class="line">	Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</div><div class="line">	table = newTab;</div><div class="line">	<span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</div><div class="line">			Node&lt;K,V&gt; e;</div><div class="line">			<span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</div><div class="line">				oldTab[j] = <span class="keyword">null</span>;</div><div class="line">				<span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</div><div class="line">					newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</div><div class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</div><div class="line">					((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</div><div class="line">				<span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></div><div class="line">					Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</div><div class="line">					Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</div><div class="line">					Node&lt;K,V&gt; next;</div><div class="line">					<span class="keyword">do</span> &#123;</div><div class="line">						next = e.next;</div><div class="line">						<span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</div><div class="line">							<span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</div><div class="line">								loHead = e;</div><div class="line">							<span class="keyword">else</span></div><div class="line">								loTail.next = e;</div><div class="line">							loTail = e;</div><div class="line">						&#125;</div><div class="line">						<span class="keyword">else</span> &#123;</div><div class="line">							<span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</div><div class="line">								hiHead = e;</div><div class="line">							<span class="keyword">else</span></div><div class="line">								hiTail.next = e;</div><div class="line">							hiTail = e;</div><div class="line">						&#125;</div><div class="line">					&#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</div><div class="line">					<span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</div><div class="line">						loTail.next = <span class="keyword">null</span>;</div><div class="line">						newTab[j] = loHead;</div><div class="line">                      &#125;</div><div class="line">					<span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</div><div class="line">						hiTail.next = <span class="keyword">null</span>;</div><div class="line">                          newTab[j + oldCap] = hiHead;</div><div class="line">					&#125;</div><div class="line">                  </div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> newTab;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2017/11/23/hashmap/" class="article-date">
  <time datetime="2017-11-23T06:21:51.000Z" itemprop="datePublished">2017-11-23</time>
</a>

        </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <a href="/2017/11/28/Glide缓存机制/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Glide缓存机制
        
      </div>
    </a>
  
  
    <a href="/2017/08/03/okhttp/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">okhttp</div>
    </a>
  
</nav>


  
</article>










      </div>
      
    <footer id="footer" class="post-footer footer">
      
        <ul class="footer-links">
          
            <li><a href="/archives/"><span class="fa fa-book"></span></a></li>
          
            <li><a href="https://github.com/chanchangxing"><span class="fa fa-globe"></span></a></li>
          
        </ul>
	    
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>这篇写完就删站</p>


      </div>
    </footer>

      







<script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3/dist/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
